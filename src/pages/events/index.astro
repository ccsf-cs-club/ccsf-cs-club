---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import Calendar from "../../components/Calendar.astro";
import EventCard from "../../components/EventCard.astro";

// Get all events from content collection
const allEvents = await getCollection('events');

// Sort events by date (most recent first)
const sortedEvents = allEvents.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Get featured events
const featuredEvents = sortedEvents.filter(event => event.data.featured && event.data.status === 'completed');

// Get upcoming events
const upcomingEvents = sortedEvents.filter(event => event.data.status === 'upcoming');

// Get completed events by year
const completedEvents = sortedEvents.filter(event => event.data.status === 'completed');
const eventsByYear = completedEvents.reduce((acc, event) => {
  const year = event.data.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(event);
  return acc;
}, {} as Record<number, typeof completedEvents>);

// Prepare events for calendar
const calendarEvents = allEvents.map(event => ({
  title: event.data.title,
  date: event.data.date,
  endDate: event.data.endDate,
  location: event.data.location,
  category: event.data.category,
}));

const currentYear = new Date().getFullYear();
---

<Layout title="CS Club Events">
  <main class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Hero Section -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-16">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-5xl md:text-6xl font-bold mb-4">Events</h1>
        <p class="text-xl md:text-2xl mb-6 max-w-3xl mx-auto">
          Join our community events, workshops, and tech talks. From hands-on coding sessions to industry networking, there's something for everyone.
        </p>
        <div class="flex flex-wrap justify-center gap-4 text-sm">
          <div class="bg-white/20 px-4 py-2 rounded-full">ğŸ¯ Workshops</div>
          <div class="bg-white/20 px-4 py-2 rounded-full">ğŸ¤ Networking</div>
          <div class="bg-white/20 px-4 py-2 rounded-full">ğŸ† Competitions</div>
          <div class="bg-white/20 px-4 py-2 rounded-full">ğŸ“š Learning</div>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 py-12">
      <!-- Upcoming Events Section -->
      {upcomingEvents.length > 0 && (
        <section class="mb-16">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
            ğŸ”¥ Upcoming Events
          </h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 mb-8">
            {upcomingEvents.map((event) => (
              <EventCard
                title={event.data.title}
                date={event.data.date}
                endDate={event.data.endDate}
                location={event.data.location}
                description={event.data.description}
                category={event.data.category}
                images={event.data.images}
                external_link={event.data.external_link}
                tags={event.data.tags}
                status={event.data.status}
                featured={event.data.featured}
                content={event.body}
              />
            ))}
          </div>
        </section>
      )}

      <!-- Calendar Section -->
      <section class="mb-16">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
          ğŸ“… Event Calendar
        </h2>
        <Calendar events={calendarEvents} />
      </section>

      <!-- Featured Events Section -->
      {featuredEvents.length > 0 && (
        <section class="mb-16">
          <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
            â­ Featured Events
          </h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {featuredEvents.slice(0, 6).map((event) => (
              <EventCard
                title={event.data.title}
                date={event.data.date}
                endDate={event.data.endDate}
                location={event.data.location}
                description={event.data.description}
                category={event.data.category}
                images={event.data.images}
                external_link={event.data.external_link}
                tags={event.data.tags}
                status={event.data.status}
                featured={event.data.featured}
                content={event.body}
              />
            ))}
          </div>
        </section>
      )}

      <!-- Event History Section -->
      <section>
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-8 text-center">
          ğŸ“š Event History
        </h2>
        
        {Object.keys(eventsByYear)
          .sort((a, b) => parseInt(b) - parseInt(a))
          .map((year) => (
            <div class="mb-12">
              <h3 class="text-2xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-3">
                <span class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-4 py-2 rounded-full">
                  {year}
                </span>
                <span class="text-gray-400">({eventsByYear[year].length} events)</span>
              </h3>
              
              <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {eventsByYear[year].map((event) => (
                  <EventCard
                    title={event.data.title}
                    date={event.data.date}
                    endDate={event.data.endDate}
                    location={event.data.location}
                    description={event.data.description}
                    category={event.data.category}
                    images={event.data.images}
                    external_link={event.data.external_link}
                    tags={event.data.tags}
                    status={event.data.status}
                    featured={event.data.featured}
                    content={event.body}
                  />
                ))}
              </div>
            </div>
          ))
        }
      </section>
    </div>
  </main>
</Layout>
